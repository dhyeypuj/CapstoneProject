<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralGuard AI | Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top right, #1e1b4b 0%, #050507 40%);
            background-color: #050507;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(18, 18, 24, 0.7);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .neon-purple-glow {
            box-shadow: 0 0 30px rgba(192, 38, 211, 0.15);
        }

        .btn-gradient {
            background: linear-gradient(135deg, #c026d3, #6366f1);
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            box-shadow: 0 0 25px rgba(192, 38, 211, 0.4);
            transform: translateY(-1px);
        }

        .btn-google {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .btn-google:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .input-field {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.15);
            outline: none;
        }

        .divider-line {
            background: rgba(255, 255, 255, 0.08);
        }

        .error-toast {
            background: rgba(220, 38, 38, 0.15);
            border: 1px solid rgba(220, 38, 38, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(192, 38, 211, 0.15);
            }

            50% {
                box-shadow: 0 0 35px rgba(192, 38, 211, 0.25);
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 3s ease-in-out infinite;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-6">

    <!-- Error Toast -->
    <div id="error-toast"
        class="error-toast fixed top-6 right-6 px-6 py-4 rounded-2xl text-red-400 text-sm font-medium z-50 hidden">
        <span id="error-message"></span>
    </div>

    <div class="glass-panel rounded-[2.5rem] p-10 w-full max-w-md neon-purple-glow animate-pulse-glow">

        <!-- Logo -->
        <div class="flex items-center justify-center gap-3 mb-10">
            <div
                class="w-10 h-10 bg-gradient-to-br from-fuchsia-600 to-indigo-600 rounded-xl shadow-[0_0_15px_rgba(192,38,211,0.5)]">
            </div>
            <h1 class="text-xl font-bold tracking-tight">NEURALGUARD AI</h1>
        </div>

        <!-- Title -->
        <div class="text-center mb-8">
            <h2 id="form-title" class="text-2xl font-bold tracking-tight">Welcome Back</h2>
            <p id="form-subtitle" class="text-slate-500 text-sm mt-2">Sign in to access the dashboard</p>
        </div>

        <!-- Google Sign-In Button -->
        <button id="google-btn" onclick="signInWithGoogle()"
            class="btn-google w-full flex items-center justify-center gap-3 p-4 rounded-2xl text-sm font-semibold mb-6">
            <svg width="18" height="18" viewBox="0 0 18 18">
                <path fill="#4285F4"
                    d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 01-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z" />
                <path fill="#34A853"
                    d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z" />
                <path fill="#FBBC05"
                    d="M3.964 10.71A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.997 8.997 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.332z" />
                <path fill="#EA4335"
                    d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 00.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z" />
            </svg>
            Continue with Google
        </button>

        <!-- Divider -->
        <div class="flex items-center gap-4 mb-6">
            <div class="divider-line h-px flex-1"></div>
            <span class="text-slate-500 text-xs font-medium uppercase tracking-wider">or</span>
            <div class="divider-line h-px flex-1"></div>
        </div>

        <!-- Email/Password Form -->
        <form id="auth-form" onsubmit="handleEmailAuth(event)">
            <!-- Name field (only for register) -->
            <div id="name-field" class="mb-4 hidden">
                <label class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-2 block">Full
                    Name</label>
                <input id="name-input" type="text" placeholder="John Doe"
                    class="input-field w-full p-4 rounded-2xl text-sm text-white placeholder-slate-600">
            </div>

            <div class="mb-4">
                <label class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-2 block">Email</label>
                <input id="email-input" type="email" placeholder="you@example.com" required
                    class="input-field w-full p-4 rounded-2xl text-sm text-white placeholder-slate-600">
            </div>

            <div class="mb-6">
                <label class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-2 block">Password</label>
                <input id="password-input" type="password" placeholder="••••••••" required minlength="6"
                    class="input-field w-full p-4 rounded-2xl text-sm text-white placeholder-slate-600">
            </div>

            <button type="submit" id="submit-btn"
                class="btn-gradient w-full p-4 rounded-2xl text-sm font-bold text-white shadow-lg">
                Sign In
            </button>
        </form>

        <!-- Toggle Login/Register -->
        <p class="text-center text-slate-500 text-sm mt-6">
            <span id="toggle-text">Don't have an account?</span>
            <button id="toggle-btn" onclick="toggleMode()"
                class="text-fuchsia-400 font-semibold hover:text-fuchsia-300 ml-1">
                Register
            </button>
        </p>
    </div>

    <!-- Firebase Client SDK (compat version for simplicity) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <script>
        // Firebase client config — API key is injected server-side via EJS
        const firebaseConfig = {
            apiKey: "<%= firebaseApiKey %>",
            authDomain: "capstone38-554e6.firebaseapp.com",
            projectId: "capstone38-554e6",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        let isRegisterMode = false;

        function toggleMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('form-title').textContent = isRegisterMode ? 'Create Account' : 'Welcome Back';
            document.getElementById('form-subtitle').textContent = isRegisterMode ? 'Register to access the dashboard' : 'Sign in to access the dashboard';
            document.getElementById('submit-btn').textContent = isRegisterMode ? 'Create Account' : 'Sign In';
            document.getElementById('toggle-text').textContent = isRegisterMode ? 'Already have an account?' : "Don't have an account?";
            document.getElementById('toggle-btn').textContent = isRegisterMode ? 'Sign In' : 'Register';
            document.getElementById('name-field').classList.toggle('hidden', !isRegisterMode);
        }

        function showError(msg) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-message').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        async function sendTokenToServer(idToken) {
            const res = await fetch('/sessionLogin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken }),
            });
            if (res.ok) {
                // Sign out from Firebase client (server session takes over)
                await auth.signOut();
                window.location.href = '/';
            } else {
                const data = await res.json();
                showError(data.error || 'Session login failed.');
            }
        }

        async function handleEmailAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;

            try {
                let userCredential;
                if (isRegisterMode) {
                    userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const displayName = document.getElementById('name-input').value;
                    if (displayName) {
                        await userCredential.user.updateProfile({ displayName });
                    }
                } else {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                }
                const idToken = await userCredential.user.getIdToken();
                await sendTokenToServer(idToken);
            } catch (err) {
                let message = 'Authentication failed.';
                if (err.code === 'auth/user-not-found') message = 'No account found with this email.';
                else if (err.code === 'auth/wrong-password') message = 'Incorrect password.';
                else if (err.code === 'auth/email-already-in-use') message = 'This email is already registered.';
                else if (err.code === 'auth/weak-password') message = 'Password must be at least 6 characters.';
                else if (err.code === 'auth/invalid-email') message = 'Invalid email address.';
                else if (err.code === 'auth/invalid-credential') message = 'Invalid email or password.';
                showError(message);
            }
        }

        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const idToken = await result.user.getIdToken();
                await sendTokenToServer(idToken);
            } catch (err) {
                if (err.code !== 'auth/popup-closed-by-user') {
                    showError(err.message || 'Google sign-in failed.');
                }
            }
        }
    </script>
</body>

</html>